<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tabela com Avaliação por Estrelas</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Estrelas */
    .stars {
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }

    .star {
      font-size: 1.4rem;
      cursor: pointer;
      user-select: none;
      color: #d6d6d6;
      /* cor padrão */
      transition: transform .08s ease;
    }

    .star:hover {
      transform: scale(1.05);
    }

    .star.selected {
      color: #f6c64f;
    }

    .rating-value {
      min-width: 30px;
      display: inline-block;
      text-align: center;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <div class="container py-5">
    <h2 class="mb-4">Produtos e Avaliações</h2>

    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>Item</th>
            <th style="width:260px">Avaliação</th>
            <th>Nota (1-5)</th>
          </tr>
        </thead>
        <tbody>
          <tr th:attr="data-id=${product.id}">
            <td th:text="${product.name}"></td>
            <td>
              <div class="stars" role="radiogroup" aria-label="Avaliação">
                <span class="star" data-value="1" tabindex="0" role="radio" aria-checked="false">★</span>
                <span class="star" data-value="2" tabindex="0" role="radio" aria-checked="false">★</span>
                <span class="star" data-value="3" tabindex="0" role="radio" aria-checked="false">★</span>
                <span class="star" data-value="4" tabindex="0" role="radio" aria-checked="false">★</span>
                <span class="star" data-value="5" tabindex="0" role="radio" aria-checked="false">★</span>
              </div>
            </td>
            <td class="rating-value" th:text="${rating.value}"></td>
          </tr>
        </tbody>
      </table>
    </div>

    <p class="text-muted small">Clique em uma estrela para avaliar. Cada estrela representa um valor de 1 (pior) a 5
      (melhor).</p>
  </div>

  <!-- Script: Bootstrap JS (opcional) e funcionalidade da avaliação -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Inicializa ratings and send to server on click
    document.querySelectorAll('tr[data-id]').forEach(function (row) {
      const stars = row.querySelectorAll('.star');
      const valueBox = row.querySelector('.rating-value');
      let current = 0;

      function updateUI(val) {
        stars.forEach(s => {
          const v = Number(s.dataset.value);
          if (v <= val) s.classList.add('selected'); else s.classList.remove('selected');
          s.setAttribute('aria-checked', v === val ? 'true' : 'false');
        });
        valueBox.textContent = val;
        current = val;
      }

      // clique
      stars.forEach(s => {
        s.addEventListener('click', function () {
          const v = Number(this.dataset.value);
          const newVal = (v === current) ? 0 : v;
          updateUI(newVal);
          // send rating to server (only when > 0)
          const pid = Number(row.getAttribute('data-id'));
          if (newVal > 0 && pid) {
            fetch('/rating/rate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ productId: pid, value: newVal })
            }).then(r => r.json()).then(data => {
              if (data && data.value !== undefined) {
                valueBox.textContent = data.value;
                current = Math.round(data.value);
                // update UI to reflect average as selected stars
                updateUI(current);
              }
            }).catch(err => console.error('rating error', err));
          }
        });

        // suporte teclado (Enter / Space) e navegação com setas
        s.addEventListener('keydown', function (e) {
          const v = Number(this.dataset.value);
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const newVal = (v === current) ? 0 : v;
            updateUI(newVal);
          } else if (e.key === 'ArrowLeft') {
            e.preventDefault();
            const prev = Math.max(0, current - 1);
            updateUI(prev);
            // move foco
            const focusIndex = Math.max(0, prev - 1);
            if (stars[focusIndex]) stars[focusIndex].focus();
          } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            const nxt = Math.min(5, current + 1);
            updateUI(nxt);
            const focusIndex = Math.max(0, nxt - 1);
            if (stars[focusIndex]) stars[focusIndex].focus();
          }
        });

        // hover preview (opcional)
        s.addEventListener('mouseenter', function () {
          const v = Number(this.dataset.value);
          stars.forEach(ss => {
            if (Number(ss.dataset.value) <= v) ss.classList.add('selected');
            else ss.classList.remove('selected');
          });
        });

        s.addEventListener('mouseleave', function () {
          updateUI(current);
        });
      });

      // iniciar com 0
      updateUI(0);
    });
  </script>
</body>

</html>